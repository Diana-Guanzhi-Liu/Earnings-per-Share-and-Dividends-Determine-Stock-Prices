---
title: "My title"
subtitle: "Analysis of the Relationship Between Stock Price and EPS & Dividends of the Largest 50 North American Companies over 10 Years"
author: Diana Liu
thanks: "Code and data are available at: LINK."
date: today
date-format: long
abstract: "First sentence. Second sentence. Third sentence. Fourth sentence."
format: pdf
number-sections: true
bibliography: references.bib
---

```{r}
#| include: false
#| warning: false
#| message: false

library(tidyverse)
library(arrow)
library(modelsummary)
library(bayesplot)
library(broom)
library(gridExtra)
library(rstanarm)
library(knitr)
#
library(gt)
library(grDevices)
```


# Introduction

You can and should cross-reference sections and sub-sections. 

The remainder of this paper is structured as follows. @sec-data....



# Data
Public companies whose stock are traded on exchanges, must disclose certain financial metrics in their quarterly and yearly financial statements. Investors then use these metrics to help inform their decision when selecting companies to invest in. Some of the most important metrics investors look at are Earnings Per Share, Net Income, and Dividends [@CiteShakespeare]. Investments take the form of buying shares or stocks which allows the investor to own a fraction of the company.

The data used for analysis is obtained through Walton Research Data Services (WRDS) by the University of Pennsylvania. WRDS provides access to Compustat, a database of financial, statistical, and market information on global companies since 1962. Our data comes from Compustat's North America Fundamentals Annual database, which contains both financial data from all public North American companies, collected by Compustat from each company's annual financial statements or from stock exchanges (@fig-Analysis-Data-Sample). From this data set, we extract the price, EPS, net income, dividends, TIC, and Year of the top 50 largest companies by market capitalization, a measure of the size of the company in terms of total value, for the past 10 years. This Data is cleaned and analysed in @CiteR with assistance from @CiteTidy, @CiteArrow, @CiteModelsummary, @CiteBayesplot, @CiteBroom, @CiteGridextra, @CiteRstanarm, @CiteKnitr

Similar data sets exist, but WRDS was selected because it hosts the most robust collection in terms of variables and its infrastructure allows users to easily query specific items.

```{r}
#| label: fig-Analysis-Data-Sample
#| fig-cap: "Data from Compustat North America Fundamentals Annual. EPS, Dividends, and Net Income are financial statement data while Price are stock exchange data, and Year and Tic can be found on both."
#| echo: false

analysis_data <- read_parquet(here::here("outputs/data/analysis_data.parquet"))
kable(head(analysis_data))
```

## Financial Statement Data
Net income, EPS, and dividends are items that are found on financial statements. Specifically, EPS and net income can be found on the income statement while dividends can be found on the statement of retained earnings. This data is likely unbiased and free from error as financial statements are required by law to be audited (verified by an independent third party).

Net income is used to measure profitability or how much income the company keeps after expenses are paid. Higher net income means that the company is profitable by either earning more revenues or reducing expenses. Net income is expected to be positively correlated with price as investors want to invest in companies that are more profitable. Net income can be negative when the company has lost money. In our data set, it is measured in millions USD (x10^6). Net income is normally distributed with median of 7120M USD and right skew, mean of 11752 (@fig-distributions). Apple (AAPL) had the highest net income in the data set of 99803 achieved in 2022, and Berkshire Hathaway (BRK.B) had the lowest of -22819 in the same year (@tbl-summary-statistics).

```{r}
#| label: fig-EPS-boxplot
#| fig-cap: "Boxplots of EPS grouped by dividends"
#| echo: false
EPS_boxplot <-
  analysis_data |> 
  ggplot(aes(x = Paid_Dividend, y = EPS)) +
  geom_boxplot() +
  theme_minimal() +
  labs(x = "Dividends Paid",
       y = "EPS")

ylim1 = boxplot.stats(analysis_data$EPS)$stats[c(1, 5)]
EPS_boxplot = EPS_boxplot + coord_cartesian(ylim = ylim1*1.05)
EPS_boxplot

```

EPS is a commonly used measure of a given company's value in USD; it is calculated net income divided by the number of shares. It is normally distributed and right skewed, with median 4.56 USD and mean 6.2 (@fig-distributions). Google (GOOGL) had the highest EPS of 112.2 in 2021, and Tesla (TSLA) had the lowest of -11.83 in 2017, meaning for each share Tesla lost 11.83 USD (@tbl-summary-statistics).

Dividends are distributions of a company's income to the owners of its stock in USD. Some companies choose not to pay dividends if they can use their income to reinvest into valuable projects. For our analysis we created a binary variable for whether or not a company paid dividends, with any amount greater than zero dollars being Yes. Approximately 78% of companies in our data set paid dividends, the largest of which was 25999 USD paid by Caterpillar (CAT) in 2023.

EPS of companies that did not pay dividends has a larger interquartile range than EPS of companies that paid dividends (@fig-EPS-boxplot). This means that the observations for companies that paid dividends are more clustered together, likely resulting in smaller standard deviation. The mean and median EPS of companies that paid dividends is also higher, suggesting that paying dividends is correlated with having higher EPS (@fig-EPS-boxplot), this makes sense as companies that are profitable enough to have high EPS also have more income to pay out dividends. 

```{r}
#| include: false

count(analysis_data)
analysis_data %>% filter(Paid_Dividend == "Yes") %>% nrow()

analysis_data %>% filter(Paid_Dividend == "Yes") %>% nrow()/count(analysis_data)
```

## Stock Exchange Data
The price is the amount that each share costs to buy, it is determined by supply and demand for a company. For example, if investors believe a company is profitable, they will buy shares with the goal of eventually sharing in said profit, increasing demand and driving up share price. Share price is normally distributed with median of 113.91 USD and mean of 6.2. The most expensive stock was Amazon (AMZN) which was worth 3334.34 USD in 2021, and the cheapest stock was Advanced Micro Devices, Inc. (AMD) which was worth 2.67 in 2014.

Tic refers to the ticker symbol of each stock. It is a unique string of one to five characters used to denote a particular company's stock so that investors know whose stock are being traded on international exchanges across different languages. Some tick symbols are similar to the name of the company like AAPL for Apple and GOOGL for Google, but this is not always the case, for example American Express is AXP and Coca-cola is KO. 

```{r}
#| echo: false
#| eval: true
#| label: tbl-summary-statistics
#| tbl-cap: "Summary statistics of Price, EPS, Net Income, and Dividends of the 50 largest North American Companies by market cap"
#| warning: false

earnings_per_share <- unclass(summary(analysis_data$EPS, digits = 3))
net_income <- unclass(summary(analysis_data$Net_Income, digits = 7))
dividends <- unclass(summary(analysis_data$Dividends, digits = 6))
price <- unclass(summary(analysis_data$Price, digits = 5))
summary <- data.frame(earnings_per_share, net_income, dividends, price, check.names = FALSE, stringsAsFactors = FALSE)

summary_stats <- c("Min", "1st Quartile", "Median", "Mean", "3rd Quartile", "Max")
summary <-
  cols_add(gt(summary), summary_stats) |>
  cols_move_to_start(summary_stats)

summary
```

```{r}
#| label: fig-distributions
#| fig-cap: "Price, EPS, Net_Income, and Dividends are all normally distributed with right skew"
#| echo: false
#| warning: false
#| message: false

distribution_price <-
  ggplot(analysis_data, aes(x = Price)) +
  geom_histogram() +
  theme_minimal()

distribution_EPS <-
  ggplot(analysis_data, aes(x = EPS)) +
  geom_histogram() +
  theme_minimal()

distribution_Dividends <-
  ggplot(analysis_data, aes(x = Dividends)) +
  geom_histogram() +
  theme_minimal()

distribution_Net_Income <-
  ggplot(analysis_data, aes(x = Net_Income)) +
  geom_histogram() +
  theme_minimal()

grid.arrange(distribution_price, distribution_EPS, distribution_Net_Income, distribution_Dividends, ncol = 2)
```


# Model

The goal of our model is to determine the relationship between EPS and stock price first with a simple linear model. Then we add a binary variable of whether the company paid dividends or not to determine the effect dividends have on this relationship. Background details and diagnostics are included in [Appendix -@sec-model-details].

## Model set-up
In the first model, we define $y_i$ as the stock price, $X_1$ as earnings per share, a continuous variable. $\beta_0$ is the intercept term, and $\beta_1$ is the coefficient for change in the stock price per dollar increase in EPS. $\epsilon$ denotes the noise or deviations.

\begin{align}
&Simple\ Model \\
&Y_i = \beta_0 + \beta_1X_1 + \epsilon \\
\end{align}

In the second model, we add $X_2$ as a binary variable where yes signifies that a company paid dividends, and $\beta_2$ is the coefficient for change in stock price if dividends were paid.
 
\begin{align} 
&Multivariable\ Model \\
&Y_i = \beta_0 + \beta_1X_1 + \beta_2X_2 + \epsilon \\
\end{align}

### Model justification
We expect a positive linear relationship between EPS and stock price. This is because a higher EPS indicates greater value and investors should be willing to pay more for a company's shares if they think the company has higher profits relative to its share price. If a company has high EPS, they have greater amount of profit after expenses have been paid. Investors want to own profitable companies, so demand for this company's stock increases, driving up price as the number of stocks that are available to be bought remains the same. The opposite is true for unprofitable companies, if EPS is low or negative, investors may choose to sell off their shares even at a loss in order to prevent further losses should the stock price keep falling (@fig-bestfit). 

One might expect dividends to be positively correlated with stock price because investors desire an additional payment, but the opposite is true. This is because dividends paid out to shareholders is value that is taken out of the company, causing price, a reflection of the firm's value, to decrease (@fig-bestfit).

We expect the effects of EPS and dividends to interact with each other, creating two potential outcomes for change in price. Companies that did not pay dividends are expected to have a larger increase in price for every additional dollar of EPS than companies that paid dividends.

# Results
```{r}
#| include: false
#| eval: true
#| warning: false
model_rstanarm_1 <-
  stan_glm(
    formula = Price ~ EPS,
    data = analysis_data,
    family = gaussian(),
    prior = normal(location = 0, scale = 2.5),
    prior_intercept = normal(location = 0, scale = 2.5),
    prior_aux = exponential(rate = 1),
    seed = 12345
  )

saveRDS(
  model_rstanarm_1,
  file = "model_rstanarm_1.rds"
)
```

```{r}
#| include: false
#| eval: true
#| warning: false
model_rstanarm_2 <-
  stan_glm(
    formula = Price ~ EPS + Paid_Dividend,
    data = analysis_data,
    family = gaussian(),
    prior = normal(location = 0, scale = 2.5, autoscale = TRUE),
    prior_intercept = normal(0, 2.5, autoscale = TRUE),
    prior_aux = exponential(rate = 1, autoscale = TRUE),
    seed = 12345
  )

saveRDS(
  model_rstanarm_2,
  file = "model_rstanarm_2.rds"
)
```

```{r}
#| include: false
#| eval: true

summary(model_rstanarm_1) 
summary(model_rstanarm_2)
```

```{r}
#| echo: false
#| warning: false
#| message: false
#| label: fig-bestfit
#| fig-cap: "Relationship between variables EPS and stock price"

base_eps_plot <-
  analysis_data |> 
  ggplot(aes(x = EPS, y = Price)) +
  geom_point(alpha = 0.5) +
  theme_minimal() +
  labs(x = "EPS",
       y = "Stock Price")

base_eps_plot +
  geom_smooth(
    method = "lm",
    se = TRUE,
    color = "black",
    linetype = "dashed",
    formula = "y ~ x"
  )
```

In model 1, only the relationship between the dependent variable price and predictor variable EPS is analyzed. In the first column of @tbl-modelresults, we have a intercept of -124.69 with standard deviation of 7.1 and coefficient of 21.79 with S.D. 1.1. The coefficient term $\beta_1$ which shows the increase in price for every dollar increase in EPS can be observed from @fig-bestfit as the dashed line with standard error as the shaded area around the dashed line. Positive slope and coefficient show a positive relationship between EPS and stock price.

```{r}
#| echo: false
#| eval: true
#| label: fig-boxplot
#| fig-cap: "Boxplots of stock price grouped by whether or not dividends were paid."
#| warning: false

dividends_plot <-
  analysis_data |> 
  ggplot(aes(x = Paid_Dividend, y = Price)) +
  geom_boxplot() +
  theme_minimal() +
  labs(x = "Dividends Paid",
       y = "Stock Price")

ylim1 = boxplot.stats(analysis_data$Price)$stats[c(1, 5)]
dividends_plot = dividends_plot + coord_cartesian(ylim = ylim1*1.05)
dividends_plot
```

```{r}
#| echo: false
#| eval: true
#| label: fig-model-2
#| fig-cap: "Linear regression "
#| warning: false

base <-
  analysis_data |>
  ggplot(aes(x = EPS, y = Price)) +
  labs(
    x = "EPS",
    y = "Price"
  ) +
  theme_classic() +
  scale_color_brewer(palette = "Set1") +
  theme(legend.position = "bottom")

base +
  geom_point(aes(color = Paid_Dividend)) +
  geom_smooth(
    aes(color = Paid_Dividend),
    method = "lm",
    linetype = "dashed",
    formula = "y ~ x"
  ) +
  labs(color = "Paid Dividends")
```

In model 2, we introduce dividends as an additional predictor variable. Stocks that paid dividends have median price around 100, significantly lower than stocks that paid no dividends with median price around 175 (@fig-boxplot), demonstrating a negative relationship between paying dividends and stock price. The second column of @tbl-modelresults shows that the new intercept is 172.05 USD, and that the coefficient of paying dividends $\beta_2$ is -177.85. EPS of companies that paid dividends has intercept of 172.05 and coefficient of 25.59 (@tbl-modelresults). The new standard deviation for EPS is 1.0 and 21.6 for dividends. 

The effects on price from EPS and dividends can be further observed in @fig-model-2 where the observations and line of best fit are colored blue to indicate that dividends were paid and red if not. EPS without dividends (red line) has very similar slope and coefficient as @fig-bestfit, and EPS with dividends (blue line) is below it and significantly shorter.


```{r}
#| echo: false
#| eval: true
#| label: tbl-modelresults
#| tbl-cap: "Effect of earnings per share and dividends on stock price."
#| warning: false

modelsummary(
  list(
    "EPS Only" = model_rstanarm_1,
    "With Dividends" = model_rstanarm_2
  ),
  fmt = 2
)
```













# Discussion

## First discussion point {#sec-first-point}

If my paper were 10 pages, then should be be at least 2.5 pages. The discussion is a chance to show off what you know and what you learnt from all this. 

## Second discussion point

## Third discussion point

## Weaknesses and next steps

Weaknesses and next steps should also be included.

\newpage

\appendix

# Appendix {-}

# Model details {#sec-model-details}


## Posterior predictive check

In @fig-ppcheckandposteriorvsprior-1 we implement a posterior predictive check. This shows...

In @fig-ppcheckandposteriorvsprior-2 we compare the posterior with the prior. This shows... 



```{r}
#| include: false
#| eval: true

model_rstanarm_1 <-
  readRDS(file = "model_rstanarm.rds")
prior_summary(model_rstanarm_1)
```

```{r}
#| include: false
#| eval: true

prior_summary(model_rstanarm_2)
```

```{r}
#| eval: true
#| echo: false
#| message: false
#| warning: false
#| label: fig-ppcheckandposteriorvsprior
#| layout-ncol: 2
#| fig-cap: "Examining how the model fits, and is affected by, the data"
#| fig-subcap: ["Posterior prediction check", "Comparing the posterior with the prior"]

pp_check(model_rstanarm_2) +
  theme_classic() +
  theme(legend.position = "bottom")

posterior_vs_prior(model_rstanarm_2) +
  theme_minimal() +
  scale_color_brewer(palette = "Set1") +
  theme(legend.position = "bottom") +
  coord_flip()
```


## Diagnostics

@fig-fig-trace-1 is a trace plot 

@fig-fig-trace-2 is a Rhat plot. It shows... This suggests...


```{r}
#| echo: false
#| eval: true
#| message: false
#| warning: false
#| label: fig-trace
#| fig-cap: "Checking the convergence of the MCMC algorithm"
#| fig-subcap: ["Trace plot", "Rhat plot"]
#| layout-ncol: 2

plot(model_rstanarm_2, "trace")

plot(model_rstanarm_2, "rhat")
```

\newpage


# References


